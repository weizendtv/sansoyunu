<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeizendTv Şans Oyunu</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, update, remove, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  // Your NEW web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDnCXQAln2oFhcCNGdtWsAqgSY8FPaDuMM",
    authDomain: "weizendtv-sans-oyunlari.firebaseapp.com",
    projectId: "weizendtv-sans-oyunlari",
    storageBucket: "weizendtv-sans-oyunlari.firebasestorage.app",
    messagingSenderId: "294249094569",
    appId: "1:294249094569:web:8d6a7ee6ea88437703f8b8"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  window.db = getDatabase(app);
  window.auth = getAuth(app);

  // Expose modular functions to the global scope for the existing script block
  window.ref = ref;
  window.onValue = onValue;
  window.set = set;
  window.update = update;
  window.remove = remove;
  window.push = push;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.onAuthStateChanged = onAuthStateChanged;
  window.signOut = signOut;

  console.log("Firebase SDK v9 başarıyla başlatıldı.");
</script>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
    line-height: 1.6;
  }
  header {
    background: linear-gradient(90deg, #b71c1c, #000);
    padding: 15px;
    font-size: 28px;
    font-weight: bold;
    letter-spacing: 1.5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  input, button {
    padding: 10px 15px;
    margin: 8px 5px;
    border-radius: 8px;
    border: 1px solid #333;
    font-size: 16px;
    background-color: #333;
    color: #eee;
    transition: all 0.3s ease;
  }
  input:focus {
    outline: none;
    border-color: #b71c1c;
    box-shadow: 0 0 8px rgba(183, 28, 28, 0.6);
  }
  button {
    background: #b71c1c;
    color: #fff;
    cursor: pointer;
    min-width: 120px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  button:hover {
    background: #ff4444;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }
  .box-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
    max-width: 800px;
    margin: 20px auto;
    padding: 0 10px;
  }
  .box {
    background: #222;
    border: 2px solid #b71c1c;
    height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    border-radius: 8px;
    position: relative;
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  .box:hover:not(.opened) {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.5);
  }
  .box.opened {
    background: #333;
    cursor: default;
    border-color: #555;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
  }
  .bomba {
    background: #ff4444 !important;
    border-color: #ff0000 !important;
    color: #fff !important;
  }
  .winner {
    background: #44ff44 !important;
    border-color: #00cc00 !important;
    color: #000 !important;
    animation: pulse 1.5s infinite alternate;
  }

  @keyframes pulse {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
  }

  #adminPanel, #loginDiv {
    margin: 30px auto;
    max-width: 550px;
    border: 1px solid #b71c1c;
    padding: 20px;
    border-radius: 12px;
    background: #222;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  #adminPanel h3, #loginDiv h2 {
    color: #ffcc00;
    margin-top: 0;
    margin-bottom: 20px;
  }
  .userItem {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    margin: 6px 0;
    background: #333;
    border-radius: 5px;
    border-left: 3px solid #b71c1c;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .userItem:hover {
    background-color: #444;
  }
  .userItem button {
    margin-left: 10px;
    padding: 5px 10px;
    font-size: 14px;
    min-width: auto;
  }
  #tablesWrapper {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin: 30px;
    flex-wrap: wrap;
  }
  .tableBox {
    text-align: left;
    background: #222;
    padding: 15px;
    border-radius: 8px;
    max-width: 350px;
    flex: 1;
    min-width: 280px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    border: 1px solid #b71c1c;
  }
  .tableBox h3 {
    color: #ffcc00;
    border-bottom: 1px solid #444;
    padding-bottom: 8px;
    margin-top: 0;
  }
  #loginDiv p {
    margin-top: 20px;
  }
  #loginDiv a {
    color: #ff4444;
    text-decoration: none;
    font-weight: bold;
    transition: color 0.2s ease;
  }
  #loginDiv a:hover {
    color: #fff;
  }

  /* Yeni Eklenen CSS Kuralları */
  .scrollable-list {
    max-height: 300px; /* Maksimum yükseklik */
    overflow-y: auto; /* Dikey kaydırma çubuğu */
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    background-color: #1a1a1a;
  }
  /* Kaydırma çubuğunun stilini güzelleştirelim */
  .scrollable-list::-webkit-scrollbar {
    width: 8px;
  }
  .scrollable-list::-webkit-scrollbar-track {
    background: #333;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb {
    background: #b71c1c;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #ff4444;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background-color: #222;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.7);
    max-width: 450px;
    width: 90%;
    text-align: center;
    position: relative;
    border: 1px solid #b71c1c;
  }
  .modal-content h4 {
    color: #ffcc00;
    margin-bottom: 20px;
  }
  .modal-content input[type="number"],
  .modal-content input[type="text"] {
    width: calc(100% - 20px);
    margin-bottom: 15px;
  }
  .modal-content button {
    margin: 5px 10px;
    min-width: 100px;
  }
  .modal-close-button {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    color: #fff;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
    min-width: auto;
  }
  .modal-close-button:hover {
    color: #ff4444;
    transform: none; /* Override button hover transform */
    box-shadow: none;
  }

  /* Responsive Düzenlemeler */
  @media (max-width: 768px) {
    .box-container {
      grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
      max-width: 95%;
    }
    header {
      font-size: 22px;
    }
    #tablesWrapper {
      flex-direction: column;
      align-items: center;
    }
    .tableBox {
      width: 90%;
      max-width: 400px;
    }
    #adminPanel, #loginDiv {
      max-width: 90%;
      padding: 15px;
    }
    input, button {
      width: calc(100% - 20px);
      box-sizing: border-box;
      margin-left: 0;
      margin-right: 0;
    }
  }
</style>
</head>
<body>
<header>WEIZENDTV ŞANS OYUNU</header>

<div id="loginDiv">
  <h2>KİCK KULLANICI ADI ZORUNLU!!</h2>
  <input type="text" id="username" placeholder="Kick Kullanıcı Adı" autocomplete="username" /><br/>
  <input type="password" id="password" placeholder="Şifre (Kayıt Ol)" autocomplete="new-password" /><br/>
  <button onclick="login()">Giriş Yap / Kayıt Ol</button>
  <p><a href="https://instagram.com/weizendtv" target="_blank" style="color:#ff4444;">Şifremi Unuttum</a></p>
</div>

<div id="gameDiv" style="display:none;">
  <h3>Hoşgeldin, <span id="currentUser"></span> <span id="role"></span></h3>
  <p id="balance">Bakiye: 0</p>
  <button onclick="logout()">Çıkış Yap</button>

  <p>Toplam Açılan Kutu Sayısı: <span id="totalOpenedBoxesCount">0</span></p>

  <div class="box-container" id="boxContainer"></div>

  <div id="tablesWrapper">
    <div class="tableBox">
      <h3>KULLANICI SIRALAMASI</h3>
      <p>Toplam Kullanıcı: <span id="totalUsersCount">0</span></p>
      <div id="allUserRankings" class="scrollable-list">Yükleniyor...</div>
    </div>
    <div class="tableBox">
      <h3>KAZANANLAR SIRALAMASI</h3>
      <div id="winners">Yükleniyor...</div>
    </div>
  </div>

  <div id="adminPanel" style="display:none;">
    <h3>Admin Paneli</h3>

    <h4>Onay Bekleyen Kullanıcılar</h4>
    <div id="pendingUsers" class="scrollable-list">Yükleniyor...</div>

    <h4>Tüm Kullanıcı İşlemleri</h4>
    <input type="number" id="globalPoint" placeholder="Puan Miktarı" min="1" /><br>
    <button onclick="changeAllPoints(true)">Toplu Puan Ekle</button>
    <button onclick="changeAllPoints(false)">Toplu Puan Sil</button>
    <br>
    <button onclick="revealAll()">Tüm Kutuları Aç</button>
    <button onclick="resetGame()">Oyunu Baştan Başlat</button>
    <br>
    <button onclick="resetDailyBoxOpenRanking()">Günlük Sıralamayı Sıfırla</button>
    <button onclick="resetAllTimeBoxOpenRanking()">Tüm Zamanları Sıfırla</button>
    <br>
    <button onclick="resetWinnersRanking()">Hediye Kazananlar Sıralamasını Sıfırla</button>


    <h4>Kullanıcı Yönetimi</h4>
    <input type="text" id="searchUser" placeholder="Kullanıcı Ara" oninput="searchUsers()" /><br>
    <div id="allUsers" class="scrollable-list">Yükleniyor...</div>
  </div>
</div>

<div id="pointAdjustmentModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <button class="modal-close-button" onclick="closePointAdjustmentModal()">&times;</button>
    <h4>Kullanıcı Puan Ayarı: <span id="adjUserName"></span></h4>
    <p>Mevcut Bakiye: <span id="adjUserBalance"></span> puan</p>
    <input type="number" id="adjAmount" placeholder="Puan Miktarı" min="1" /><br>
    <button onclick="adjustUserPoints(true)">Puan Ekle</button>
    <button onclick="adjustUserPoints(false)">Puan Çıkar</button>
  </div>
</div>

<div id="blockDurationModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <button class="modal-close-button" onclick="closeBlockDurationModal()">&times;</button>
    <h4>Kullanıcıyı Engelle: <span id="blockUserName"></span></h4>
    <p>Engelleme Süresi (Dakika):</p>
    <input type="number" id="blockDuration" placeholder="Süre (dakika)" min="1" /><br>
    <button onclick="confirmBlockUser()">Engellemeyi Onayla</button>
  </div>
</div>

<div id="blockedMessageModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h4>Hesabınız Engellendi!</h4>
    <p id="blockedReason"></p>
    <p id="blockedCountdown"></p>
    <button onclick="closeBlockedMessageModal()">Tamam</button>
  </div>
</div>


<script>
  // Firebase SDK v9 (Modular API) fonksiyonlarını kullanmak için window objesine atadık.
  // Bu, HTML'deki inline ve <script> tag'indeki fonksiyonların erişebilmesini sağlar.
  const db = window.db;
  const auth = window.auth;
  const ref = window.ref;
  const onValue = window.onValue;
  const set = window.set;
  const update = window.update;
  const remove = window.remove;
  const push = window.push;
  const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
  const onAuthStateChanged = window.onAuthStateChanged;
  const signOut = window.signOut;

  let currentUser = null;
  let isAdmin = false;
  let boxes = [];
  const COST_PER_BOX = 500;

  const pointAdjustmentModal = document.getElementById('pointAdjustmentModal');
  const blockDurationModal = document.getElementById('blockDurationModal');
  const blockedMessageModal = document.getElementById('blockedMessageModal');

  let targetUserForAdjustment = null;
  let targetUserForBlock = null;
  let countdownInterval = null;

  // Sayfa yüklendiğinde ve oturum durumu değiştiğinde çalışacak kısım
  onAuthStateChanged(auth, user => {
    if (user) {
      // Firebase Auth ile giriş yapmış bir kullanıcı var
      const firebaseAuthUsername = user.email.split('@')[0].toLowerCase(); // E-postanın başını kullanıcı adı olarak alıyoruz
      console.log("Firebase Auth üzerinden oturum algılandı:", firebaseAuthUsername);

      // Admin özel kullanıcı adı kontrolü (Firebase Auth email'i ile)
      if (firebaseAuthUsername === "weizendtv") {
        currentUser = "WeizendTv"; // Görüntülenen isim
        isAdmin = true;
        afterLogin();
      } else {
        // Normal bir Firebase Auth kullanıcısı (eğer ilerde kullanmak istersek)
        // Şimdilik sadece Realtime DB kullanıcılarını ele alıyoruz.
        // signOut(auth) yaparak bu oturumu kapatabiliriz eğer Realtime DB'deki kullanıcılar harici bir girişse.
        // Veya Kick kullanıcı adlarını Firebase Auth ile eşleştirmemiz gerekir.
        // Şimdilik, admin dışındaki Auth kullanıcılarını direkt normal loginDiv'e yönlendiriyoruz.
        signOut(auth).then(() => {
          displayMessage("Lütfen Kick Kullanıcı Adınız ile giriş yapın.");
          document.getElementById("loginDiv").style.display = "block";
          document.getElementById("gameDiv").style.display = "none";
        });
      }
    } else {
      // Oturum yok veya çıkış yapıldı
      console.log("Firebase Auth oturumu bulunamadı.");
      document.getElementById("loginDiv").style.display = "block";
      document.getElementById("gameDiv").style.display = "none";
    }
  });


  async function login() {
    const user = document.getElementById("username").value.trim().toLowerCase();
    const pass = document.getElementById("password").value.trim();

    console.log("Giriş denemesi:", { user, pass });

    if (!user || !pass) {
      displayMessage("Kullanıcı adı ve şifre boş bırakılamaz!");
      return;
    }
    if (user.length < 3) {
      displayMessage("Kullanıcı adı en az 3 karakter olmalı!");
      return;
    }
    if (pass.length < 6) {
      displayMessage("Şifre en az 6 karakter olmalı!");
      return;
    }

    // Admin girişi (Firebase Authentication üzerinden)
    if (user === "weizendtv") {
      const adminEmail = "weizendtv@weizendtvoyun.com"; // Firebase Auth'a eklediğin e-posta
      try {
        await signInWithEmailAndPassword(auth, adminEmail, pass);
        // onAuthStateChanged tetiklenecek ve afterLogin çağrılacak
        displayMessage("Admin olarak giriş başarılı!");
      } catch (error) {
        console.error("Admin Firebase Auth giriş hatası: ", error);
        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          displayMessage("Admin kullanıcı adı veya şifresi yanlış!");
        } else {
          displayMessage("Admin girişi sırasında bir hata oluştu: " + error.message);
        }
      }
      return;
    }

    // Normal kullanıcı girişi (Realtime Database üzerinden)
    onValue(ref(db, 'users/' + user), (snap) => {
      if (snap.exists()) {
        let data = snap.val();
        console.log("Kullanıcı verisi bulundu:", data);

        if (data.password !== pass) {
          displayMessage("Şifre yanlış!");
        } else if (!data.approved) {
          displayMessage("Hesabınız admin onayı bekliyor. Lütfen bekleyin.");
        } else if (data.blocked) {
          checkUserBlockStatusAndLogin(user, data);
        } else {
          currentUser = user;
          isAdmin = false; // Normal kullanıcı
          console.log("Kullanıcı olarak giriş yapıldı:", currentUser);
          afterLogin();
        }
      } else {
        // Yeni kullanıcı kaydı
        console.log("Yeni kullanıcı kaydı yapılıyor:", user);
        set(ref(db, 'users/' + user), {
          password: pass,
          balance: 0,
          approved: false,
          blocked: false,
          blockedUntil: null,
          boxesOpenedCount: 0,
          currentSessionBoxesOpened: 0,
          registeredAt: new Date().toLocaleString()
        }).then(() => {
          displayMessage("Hesabınız başarıyla oluşturuldu! Admin onayı bekleniyor.");
        }).catch(error => {
          console.error("Firebase kayıt hatası: ", error);
          displayMessage("Kayıt olurken bir hata oluştu. Lütfen tekrar deneyin.");
        });
      }
    }, {
      onlyOnce: true // Sadece bir kere oku
    }).catch(error => {
      console.error("Firebase veritabanı okuma hatası: ", error);
      displayMessage("Giriş yaparken bir sorun oluştu (veritabanı bağlantısı). Lütfen internet bağlantınızı kontrol edin.");
    });
  }

  function checkUserBlockStatusAndLogin(userToCheck, userData = null) {
    const user = userData;
    if (user && user.blocked) {
      const blockedUntil = user.blockedUntil;
      if (blockedUntil && Date.now() < blockedUntil) {
        displayBlockedMessage(blockedUntil);
      } else if (blockedUntil && Date.now() >= blockedUntil) {
        update(ref(db, 'users/' + userToCheck), { blocked: false, blockedUntil: null })
          .then(() => {
            displayMessage("Engelleme süreniz doldu. Giriş yapılıyor...");
            currentUser = userToCheck;
            isAdmin = false;
            afterLogin();
          })
          .catch(error => console.error("Engeli kaldırma hatası:", error));
      } else {
        displayMessage("Hesabınız süresiz engellendi. Lütfen admin ile iletişime geçin.");
        document.getElementById("loginDiv").style.display = "block";
        document.getElementById("gameDiv").style.display = "none";
      }
    } else {
      currentUser = userToCheck;
      isAdmin = false;
      afterLogin();
    }
  }

  function afterLogin() {
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("gameDiv").style.display = "block";
    document.getElementById("currentUser").textContent = currentUser;
    document.getElementById("role").textContent = isAdmin ? "(Admin)" : "";

    if (isAdmin) {
      document.getElementById("adminPanel").style.display = "block";
      loadPendingUsers();
      loadAllUsers();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }

    loadBalance();
    loadUserRankingsAndBoxCounts();
    loadWinners();
    loadBoxes();
    loadTotalOpenedBoxesCount();
  }

  async function logout() {
    try {
      await signOut(auth); // Firebase Auth oturumunu kapat
      currentUser = null;
      isAdmin = false;
      location.reload(); // Sayfayı yenileyerek giriş ekranına dön
    } catch (error) {
      console.error("Çıkış yaparken hata oluştu: ", error);
      displayMessage("Çıkış yaparken bir hata oluştu.");
    }
  }

  function loadBalance() {
    if (isAdmin) {
      document.getElementById("balance").textContent = "Bakiye: ∞ (Admin)";
      return;
    }
    onValue(ref(db, 'users/' + currentUser + '/balance'), snap => {
      document.getElementById("balance").textContent = "Bakiye: " + (snap.val() || 0) + " puan";
    });
  }

  function loadUserRankingsAndBoxCounts() {
    onValue(ref(db, 'users'), userSnap => {
      let usersData = userSnap.val();

      if (!usersData) {
        document.getElementById("allUserRankings").innerHTML = "Henüz veri yok.";
        document.getElementById("totalUsersCount").textContent = "0";
        return;
      }

      let allUsersArray = Object.entries(usersData);
      let rankedUsers = [];
      let totalUsers = 0;

      allUsersArray.forEach(([username, userData]) => {
        if (username === "weizendtv" && isAdmin) return;

        totalUsers++;
        const boxesOpenedCount = userData.boxesOpenedCount || 0;
        const currentSessionBoxesOpened = userData.currentSessionBoxesOpened || 0;

        if (userData.approved && !userData.blocked) {
          rankedUsers.push({
            username: username,
            balance: userData.balance || 0,
            boxesOpenedCount: boxesOpenedCount,
            currentSessionBoxesOpened: currentSessionBoxesOpened
          });
        }
      });

      rankedUsers.sort((a, b) => b.boxesOpenedCount - a.boxesOpenedCount);

      let html = rankedUsers.map((u, i) =>
        `<b>${i + 1}.</b> ${u.username}<br>` +
        `&nbsp;&nbsp;Açılan Kutu: (Şu An) ${u.currentSessionBoxesOpened} - (Toplam) ${u.boxesOpenedCount}<br>` +
        `&nbsp;&nbsp;Puan: ${u.balance}`
      ).join("<br><br>");

      document.getElementById("allUserRankings").innerHTML = html || "Henüz sıralanacak kullanıcı yok.";
      document.getElementById("totalUsersCount").textContent = totalUsers;
    });
  }

  function loadWinners() {
    onValue(ref(db, 'winners'), snap => {
      let data = snap.val();
      if (!data) { document.getElementById("winners").innerHTML = "Henüz kazanan yok."; return; }
      let winnerCount = {};
      Object.values(data).forEach(w => { winnerCount[w.name] = (winnerCount[w.name] || 0) + 1; });
      let sorted = Object.entries(winnerCount).sort((a,b) => b[1]-a[1]).slice(0,10);
      let html = sorted.map((w,i) => `<b>${i+1}.</b> 🎁 ${w[0]} - ${w[1]}x`).join("<br>");
      document.getElementById("winners").innerHTML = html;
    });
  }

  function loadPendingUsers() {
    onValue(ref(db, 'users'), snap => {
      const data = snap.val();
      let html = "";
      for (const u in data) {
        if (!data[u].approved) {
          html += `<div class="userItem">
            <span>${u} (Kayıt: ${data[u].registeredAt || 'Bilinmiyor'})</span>
            <div>
            <button onclick="approveUser('${u}')">Onayla</button>
            <button onclick="denyUser('${u}', true)" style="background: #e57373;">Sil</button></div></div>`;
        }
      }
      document.getElementById("pendingUsers").innerHTML = html || "Onay bekleyen kullanıcı yok.";
    });
  }

  function loadAllUsers() {
    onValue(ref(db, 'users'), snap => {
      const data = snap.val();
      let html = "";
      for (const u in data) {
        if (u === "weizendtv" && isAdmin) continue;

        html += `<div class="userItem" onclick="openPointAdjustmentModal('${u}')">
            <span>${u} - ${data[u].balance} puan ${data[u].blocked ? '(Engelli)' : ''}</span>
            <div>
            <button onclick="event.stopPropagation(); toggleBlockUser('${u}', ${data[u].blocked || false})">
              ${data[u].blocked ? 'Engeli Kaldır' : 'Engelle'}
            </button>
            <button onclick="event.stopPropagation(); denyUser('${u}')" style="background: #e57373;">Sil</button>
            </div>
            </div>`;
      }
      document.getElementById("allUsers").innerHTML = html || "Kullanıcı yok.";
    });
  }

  function displayMessage(message) {
    const messageBox = document.createElement('div');
    messageBox.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #333;
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      z-index: 1000;
      text-align: center;
      font-size: 18px;
      border: 2px solid #b71c1c;
    `;
    messageBox.textContent = message;
    document.body.appendChild(messageBox);

    setTimeout(() => {
      messageBox.remove();
    }, 3000);
  }

  function customConfirm(message, callback) {
    const confirmBox = document.createElement('div');
    confirmBox.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #222;
      color: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      z-index: 1000;
      text-align: center;
      font-size: 18px;
      border: 2px solid #b71c1c;
      max-width: 400px;
      width: 90%;
    `;
    confirmBox.innerHTML = `
      <p>${message}</p>
      <button id="confirmYes" style="margin-right: 15px; background: #4CAF50;">Evet</button>
      <button id="confirmNo" style="background: #f44336;">Hayır</button>
    `;
    document.body.appendChild(confirmBox);

    document.getElementById('confirmYes').onclick = () => {
      confirmBox.remove();
      callback(true);
    };
    document.getElementById('confirmNo').onclick = () => {
      confirmBox.remove();
      callback(false);
    };
  }

  function openPointAdjustmentModal(username) {
    targetUserForAdjustment = username;
    document.getElementById('adjUserName').textContent = username;
    onValue(ref(db, 'users/' + username + '/balance'), snap => {
      document.getElementById('adjUserBalance').textContent = snap.val() || 0;
    }, {
      onlyOnce: true
    }).catch(error => console.error("Bakiye okuma hatası:", error));
    pointAdjustmentModal.style.display = 'flex';
  }

  function closePointAdjustmentModal() {
    pointAdjustmentModal.style.display = 'none';
    document.getElementById('adjAmount').value = '';
    targetUserForAdjustment = null;
  }

  function adjustUserPoints(add) {
    const amount = parseInt(document.getElementById('adjAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("Geçerli bir pozitif puan miktarı girin!");
      return;
    }

    onValue(ref(db, 'users/' + targetUserForAdjustment), (snap) => {
      let userBalance = snap.val().balance || 0;
      userBalance = add ? userBalance + amount : Math.max(userBalance - amount, 0);
      set(ref(db, 'users/' + targetUserForAdjustment + '/balance'), userBalance)
        .then(() => {
          displayMessage(`${targetUserForAdjustment} kullanıcısının yeni bakiyesi: ${userBalance} puan`);
          closePointAdjustmentModal();
          loadAllUsers();
          loadUserRankingsAndBoxCounts();
        })
        .catch(error => console.error("Bakiye güncelleme hatası: ", error));
    }, {
      onlyOnce: true
    }).catch(error => console.error("Kullanıcı verisi okuma hatası: ", error));
  }

  function openBlockDurationModal(username) {
    targetUserForBlock = username;
    document.getElementById('blockUserName').textContent = username;
    blockDurationModal.style.display = 'flex';
  }

  function closeBlockDurationModal() {
    blockDurationModal.style.display = 'none';
    document.getElementById('blockDuration').value = '';
    targetUserForBlock = null;
  }

  function confirmBlockUser() {
    const duration = parseInt(document.getElementById('blockDuration').value);
    if (isNaN(duration) || duration <= 0) {
      displayMessage("Geçerli bir pozitif süre (dakika) girin!");
      return;
    }

    const blockedUntil = Date.now() + duration * 60 * 1000;
    update(ref(db, 'users/' + targetUserForBlock), {
      blocked: true,
      blockedUntil: blockedUntil
    }).then(() => {
      displayMessage(`${targetUserForBlock} kullanıcısı ${duration} dakika engellendi.`);
      closeBlockDurationModal();
      loadAllUsers();
      loadUserRankingsAndBoxCounts();
    }).catch(error => console.error("Kullanıcı engelleme hatası:", error));
  }

  function toggleBlockUser(user, currentStatus) {
    if (currentStatus) {
      customConfirm(user + " kullanıcısının engelini kaldırmak istediğinize emin misiniz?", (result) => {
        if (result) {
          update(ref(db, 'users/' + user), { blocked: false, blockedUntil: null })
            .then(() => {
              displayMessage(user + " kullanıcısının engeli kaldırıldı.");
              loadAllUsers();
              loadUserRankingsAndBoxCounts();
            })
            .catch(error => console.error("Engeli kaldırma hatası: ", error));
        }
      });
    } else {
      openBlockDurationModal(user);
    }
  }

  function approveUser(user) {
    customConfirm(user + " kullanıcısını onaylamak istediğinize emin misiniz?", (result) => {
      if (result) {
        update(ref(db, 'users/' + user), { approved: true, blocked: false, blockedUntil: null })
          .then(() => {
            displayMessage(user + " kullanıcısı onaylandı.");
            loadPendingUsers();
            loadAllUsers();
            loadUserRankingsAndBoxCounts();
          }).catch(error => console.error("Kullanıcı onaylama hatası: ", error));
      }
    });
  }

  function denyUser(user, fromPending = false) {
    customConfirm(user + " kullanıcısını tamamen silmek istediğinize emin misiniz? Bu işlem geri alınamaz ve kullanıcı adı tekrar kullanılabilir hale gelir!", (result) => {
      if (result) {
        remove(ref(db, 'users/' + user))
          .then(() => {
            displayMessage(user + " kullanıcısı silindi ve adı tekrar kullanılabilir.");
            if (fromPending) {
              loadPendingUsers();
            }
            loadAllUsers();
            loadUserRankingsAndBoxCounts();
          }).catch(error => console.error("Kullanıcı silme hatası: ", error));
      }
    });
  }

  function changeAllPoints(add) {
    const amount = parseInt(document.getElementById("globalPoint").value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("Geçerli bir pozitif puan miktarı girin!");
      return;
    }

    customConfirm(`Tüm onaylı ve engellenmemiş kullanıcılara ${add ? 'eklemek' : 'silmek'} istediğinizden emin misiniz?`, (result) => {
      if (result) {
        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {}; // Renamed from 'updates' to 'updatesObj' to avoid conflict with imported 'update' function
          snap.forEach(child => {
            if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
              let balance = child.val().balance || 0;
              balance = add ? balance + amount : Math.max(balance - amount, 0);
              updatesObj['users/' + child.key + '/balance'] = balance;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("Tüm onaylı kullanıcıların bakiyeleri güncellendi."))
            .catch(error => console.error("Toplu bakiye güncelleme hatası: ", error));
        }, {
          onlyOnce: true
        });
      }
    });
  }

  function createBoxes() {
    boxes = [];
    const totalBoxes = 100;
    const winnerCount = 1;
    const pointsPerWinner = 1000;

    for (let i = 1; i <= totalBoxes; i++) {
      boxes.push({ id: i, content: 'bomba', opened: false, opener: '' });
    }

    let selectedWinners = new Set();
    while (selectedWinners.size < winnerCount) {
      let winnerIndex = Math.floor(Math.random() * totalBoxes);
      if (!selectedWinners.has(winnerIndex)) {
        selectedWinners.add(winnerIndex);
        boxes[winnerIndex].content = 'surpriz';
        boxes[winnerIndex].points = pointsPerWinner;
      }
    }
    set(ref(db, 'boxes'), boxes)
      .then(() => console.log("Kutular oluşturuldu/sıfırlandı."))
      .catch(error => console.error("Kutu oluşturma hatası: ", error));
  }

  function loadBoxes() {
    onValue(ref(db, 'boxes'), snap => {
      if (!snap.exists()) {
        createBoxes();
      } else {
        boxes = snap.val();
        renderBoxes();
        loadTotalOpenedBoxesCount();
      }
    });
  }

  function renderBoxes() {
    const container = document.getElementById("boxContainer");
    container.innerHTML = '';
    boxes.forEach((box, i) => {
      let div = document.createElement('div');
      div.className = 'box ' + (box.opened ? 'opened' : '');
      if (box.opened) {
        div.textContent = box.content === 'bomba' ? '💣' : '🎁 Tebrikler!';
        if (box.opener) {
          let openerDiv = document.createElement('div');
          openerDiv.className = 'opener';
          openerDiv.textContent = box.opener;
          div.appendChild(openerDiv);
        }
      } else {
        div.textContent = box.id;
      }
      div.onclick = () => openBox(i);
      if (box.content === 'bomba' && box.opened) div.classList.add('bomba');
      if (box.content === 'surpriz' && box.opened) div.classList.add('winner');
      container.appendChild(div);
    });
  }

  function openBox(index) {
    if (boxes[index].opened) return;

    if (isAdmin) { // Adminler puan harcamadan kutu açabilir
      boxes[index].opened = true;
      boxes[index].opener = 'Admin';
      set(ref(db, 'boxes'), boxes)
        .then(() => renderBoxes())
        .catch(error => console.error("Admin kutu açma hatası: ", error));
      return;
    }

    onValue(ref(db, 'users/' + currentUser), (snap) => {
      let user = snap.val();
      if (!user) {
        displayMessage("Kullanıcı bilginiz bulunamadı. Lütfen tekrar giriş yapın.");
        logout();
        return;
      }
      if (user.blocked) {
        displayMessage("Hesabınız engelli olduğu için kutu açamazsınız.");
        return;
      }
      if (user.balance < COST_PER_BOX) {
        displayMessage(`Kutu açmak için ${COST_PER_BOX} puana ihtiyacın var. Mevcut bakiyen: ${user.balance}.`);
        return;
      }

      user.balance -= COST_PER_BOX;
      boxes[index].opened = true;
      boxes[index].opener = currentUser;

      user.boxesOpenedCount = (user.boxesOpenedCount || 0) + 1;
      user.currentSessionBoxesOpened = (user.currentSessionBoxesOpened || 0) + 1;

      const updatesObj = {};
      updatesObj['users/' + currentUser + '/balance'] = user.balance;
      updatesObj['users/' + currentUser + '/boxesOpenedCount'] = user.boxesOpenedCount;
      updatesObj['users/' + currentUser + '/currentSessionBoxesOpened'] = user.currentSessionBoxesOpened;
      updatesObj['boxes'] = boxes;

      if (boxes[index].content === 'surpriz') {
        const pointsWon = boxes[index].points || 1000;
        user.balance += pointsWon;
        updatesObj['users/' + currentUser + '/balance'] = user.balance;
        push(ref(db, 'winners'), { name: currentUser, date: new Date().toLocaleString(), points: pointsWon });
        displayMessage(`Tebrikler! ${pointsWon} puan kazandınız! Yeni bakiyeniz: ${user.balance}`);
      } else {
        displayMessage(`Kutu açıldı. ${COST_PER_BOX} puan harcadınız. Yeni bakiyeniz: ${user.balance}`);
      }

      update(ref(db), updatesObj)
        .then(() => renderBoxes())
        .catch(error => console.error("Kutu açma işlemi hatası: ", error));
    }, {
      onlyOnce: true
    }).catch(error => {
      console.error("Kullanıcı verisi okuma hatası: ", error);
      displayMessage("Kutu açılırken bir hata oluştu. Lütfen internet bağlantınızı veya konsolu kontrol edin.");
    });
  }

  function revealAll() {
    customConfirm("Tüm kutuları açmak istediğinize emin misiniz?", (result) => {
      if (result) {
        boxes.forEach(b => {
          if (!b.opened) {
            b.opened = true;
            b.opener = 'Admin (Hepsi Açıldı)';
          }
        });
        set(ref(db, 'boxes'), boxes)
          .then(() => renderBoxes())
          .catch(error => console.error("Tüm kutuları açma hatası: ", error));
      }
    });
  }

  function resetGame() {
    customConfirm("Oyunu sıfırlamak istediğinize emin misiniz? Tüm kutular kapanacak ve yeni bir kazanan kutusu belirlenecek. Kullanıcı bakiyeleri etkilenmez.", (result) => {
      if (result) {
        createBoxes();

        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {};
          snap.forEach(child => {
            if (child.key !== "weizendtv") { // Admini sıfırlama dışında bırak
              updatesObj['users/' + child.key + '/currentSessionBoxesOpened'] = 0;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("Oyun başarıyla sıfırlandı. Tüm kullanıcıların günlük kutu açma sayıları sıfırlandı."))
            .catch(error => console.error("Günlük kutu açma sıfırlama hatası: ", error));
        }, {
          onlyOnce: true
        }).catch(error => console.error("Kullanıcıları sıfırlama hatası:", error));
      }
    });
  }

  function resetDailyBoxOpenRanking() {
    customConfirm("Tüm kullanıcıların 'Şu An Açılan Kutu' sayılarını sıfırlamak istediğinize emin misiniz? Bu işlem geri alınamaz.", (result) => {
      if (result) {
        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {};
          snap.forEach(child => {
            if (child.key !== "weizendtv") { // Admini sıfırlama dışında bırak
              updatesObj['users/' + child.key + '/currentSessionBoxesOpened'] = 0;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("Tüm kullanıcıların günlük kutu açma sayıları sıfırlandı."))
            .catch(error => console.error("Günlük kutu açma sıfırlama hatası: ", error));
        }, {
          onlyOnce: true
        });
      }
    });
  }

  function resetAllTimeBoxOpenRanking() {
    customConfirm("Tüm kullanıcıların 'Toplam Açılan Kutu' sayılarını sıfırlamak istediğinize emin misiniz? Bu işlem geri alınamaz.", (result) => {
      if (result) {
        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {};
          snap.forEach(child => {
            if (child.key !== "weizendtv") { // Admini sıfırlama dışında bırak
              updatesObj['users/' + child.key + '/boxesOpenedCount'] = 0;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("Tüm kullanıcıların tüm zamanlar kutu açma sayıları sıfırlandı."))
            .catch(error => console.error("Tüm zamanlar kutu açma sıfırlama hatası: ", error));
        }, {
          onlyOnce: true
        });
      }
    });
  }

  function resetWinnersRanking() {
    customConfirm("Hediye kazananlar sıralamasını sıfırlamak istediğinize emin misiniz? Bu işlem geri alınamaz.", (result) => {
      if (result) {
        remove(ref(db, 'winners'))
          .then(() => displayMessage("Hediye kazananlar sıralaması sıfırlandı."))
          .catch(error => console.error("Kazananlar sıralaması sıfırlama hatası: ", error));
      }
    });
  }

  function loadTotalOpenedBoxesCount() {
    onValue(ref(db, 'boxes'), snap => {
      const allBoxes = snap.val();
      let openedCount = 0;
      if (allBoxes) {
        openedCount = allBoxes.filter(box => box.opened).length;
      }
      document.getElementById('totalOpenedBoxesCount').textContent = openedCount;
    });
  }

  function searchUsers() {
    const term = document.getElementById("searchUser").value.trim().toLowerCase();
    onValue(ref(db, 'users'), (snap) => {
      const data = snap.val();
      let html = "";
      for (const u in data) {
        if (u === "weizendtv" && isAdmin) continue;

        if (u.toLowerCase().includes(term)) {
          html += `<div class="userItem" onclick="openPointAdjustmentModal('${u}')">
            <span>${u} - ${data[u].balance} puan ${data[u].blocked ? '(Engelli)' : ''}</span>
            <div>
            <button onclick="event.stopPropagation(); toggleBlockUser('${u}', ${data[u].blocked || false})">
              ${data[u].blocked ? 'Engeli Kaldır' : 'Engelle'}
            </button>
            <button onclick="event.stopPropagation(); denyUser('${u}')" style="background: #e57373;">Sil</button>
            </div>
            </div>`;
        }
      }
      document.getElementById("allUsers").innerHTML = html || "Kullanıcı bulunamadı.";
    }, {
      onlyOnce: true
    });
  }

  function displayBlockedMessage(blockedUntil) {
    blockedMessageModal.style.display = 'flex';
    document.getElementById('blockedReason').textContent = "Hesabınız geçici olarak engellendi.";

    clearInterval(countdownInterval);

    const updateCountdown = () => {
      const timeLeft = blockedUntil - Date.now();
      if (timeLeft <= 0) {
        document.getElementById('blockedCountdown').textContent = "Engel süreniz doldu. Lütfen tekrar giriş yapın.";
        clearInterval(countdownInterval);
        update(ref(db, 'users/' + currentUser), { blocked: false, blockedUntil: null })
          .then(() => {
            displayMessage("Engeliniz kaldırıldı, lütfen tekrar giriş yapın.");
            closeBlockedMessageModal();
            // Burada kullanıcıyı otomatik olarak tekrar denetleyebiliriz veya logout ile sıfırlayabiliriz.
            // Şimdilik logout çağırarak giriş ekranına dönmesini sağlayalım.
            logout();
          })
          .catch(error => console.error("Engeli kaldırma hatası:", error));

        return;
      }

      const minutes = Math.floor(timeLeft / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      document.getElementById('blockedCountdown').textContent = `Kalan süre: ${minutes} dakika ${seconds} saniye`;
    };

    countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
  }

  function closeBlockedMessageModal() {
    blockedMessageModal.style.display = 'none';
    clearInterval(countdownInterval);
    logout();
  }
</script>
</body>
</html>
