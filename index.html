<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeizendTv Åans Oyunu</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, update, remove, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

  // Your NEW web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDnCXQAln2oFhcCNGdtWsAqgSY8FPaDuMM",
    authDomain: "weizendtv-sans-oyunlari.firebaseapp.com",
    projectId: "weizendtv-sans-oyunlari",
    storageBucket: "weizendtv-sans-oyunlari.firebasestorage.app",
    messagingSenderId: "294249094569",
    appId: "1:294249094569:web:8d6a7ee6ea88437703f8b8"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  window.db = getDatabase(app);
  window.auth = getAuth(app);

  // Expose modular functions to the global scope for the existing script block
  window.ref = ref;
  window.onValue = onValue;
  window.set = set;
  window.update = update;
  window.remove = remove;
  window.push = push;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.onAuthStateChanged = onAuthStateChanged;
  window.signOut = signOut;

  console.log("Firebase SDK v9 baÅŸarÄ±yla baÅŸlatÄ±ldÄ±.");
</script>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
    line-height: 1.6;
  }
  header {
    background: linear-gradient(90deg, #b71c1c, #000);
    padding: 15px;
    font-size: 28px;
    font-weight: bold;
    letter-spacing: 1.5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  input, button {
    padding: 10px 15px;
    margin: 8px 5px;
    border-radius: 8px;
    border: 1px solid #333;
    font-size: 16px;
    background-color: #333;
    color: #eee;
    transition: all 0.3s ease;
  }
  input:focus {
    outline: none;
    border-color: #b71c1c;
    box-shadow: 0 0 8px rgba(183, 28, 28, 0.6);
  }
  button {
    background: #b71c1c;
    color: #fff;
    cursor: pointer;
    min-width: 120px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  button:hover {
    background: #ff4444;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }
  .box-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 8px;
    max-width: 800px;
    margin: 20px auto;
    padding: 0 10px;
  }
  .box {
    background: #222;
    border: 2px solid #b71c1c;
    height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    border-radius: 8px;
    position: relative;
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  .box:hover:not(.opened) {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.5);
  }
  .box.opened {
    background: #333;
    cursor: default;
    border-color: #555;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
  }
  .bomba {
    background: #ff4444 !important;
    border-color: #ff0000 !important;
    color: #fff !important;
  }
  .winner {
    background: #44ff44 !important;
    border-color: #00cc00 !important;
    color: #000 !important;
    animation: pulse 1.5s infinite alternate;
  }

  @keyframes pulse {
    from { transform: scale(1); }
    to { transform: scale(1.05); }
  }

  #adminPanel, #loginDiv {
    margin: 30px auto;
    max-width: 550px;
    border: 1px solid #b71c1c;
    padding: 20px;
    border-radius: 12px;
    background: #222;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  #adminPanel h3, #loginDiv h2 {
    color: #ffcc00;
    margin-top: 0;
    margin-bottom: 20px;
  }
  .userItem {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    margin: 6px 0;
    background: #333;
    border-radius: 5px;
    border-left: 3px solid #b71c1c;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .userItem:hover {
    background-color: #444;
  }
  .userItem button {
    margin-left: 10px;
    padding: 5px 10px;
    font-size: 14px;
    min-width: auto;
  }
  #tablesWrapper {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin: 30px;
    flex-wrap: wrap;
  }
  .tableBox {
    text-align: left;
    background: #222;
    padding: 15px;
    border-radius: 8px;
    max-width: 350px;
    flex: 1;
    min-width: 280px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    border: 1px solid #b71c1c;
  }
  .tableBox h3 {
    color: #ffcc00;
    border-bottom: 1px solid #444;
    padding-bottom: 8px;
    margin-top: 0;
  }
  #loginDiv p {
    margin-top: 20px;
  }
  #loginDiv a {
    color: #ff4444;
    text-decoration: none;
    font-weight: bold;
    transition: color 0.2s ease;
  }
  #loginDiv a:hover {
    color: #fff;
  }

  /* Yeni Eklenen CSS KurallarÄ± */
  .scrollable-list {
    max-height: 300px; /* Maksimum yÃ¼kseklik */
    overflow-y: auto; /* Dikey kaydÄ±rma Ã§ubuÄŸu */
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    background-color: #1a1a1a;
  }
  /* KaydÄ±rma Ã§ubuÄŸunun stilini gÃ¼zelleÅŸtirelim */
  .scrollable-list::-webkit-scrollbar {
    width: 8px;
  }
  .scrollable-list::-webkit-scrollbar-track {
    background: #333;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb {
    background: #b71c1c;
    border-radius: 10px;
  }
  .scrollable-list::-webkit-scrollbar-thumb:hover {
    background: #ff4444;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background-color: #222;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.7);
    max-width: 450px;
    width: 90%;
    text-align: center;
    position: relative;
    border: 1px solid #b71c1c;
  }
  .modal-content h4 {
    color: #ffcc00;
    margin-bottom: 20px;
  }
  .modal-content input[type="number"],
  .modal-content input[type="text"] {
    width: calc(100% - 20px);
    margin-bottom: 15px;
  }
  .modal-content button {
    margin: 5px 10px;
    min-width: 100px;
  }
  .modal-close-button {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    color: #fff;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
    min-width: auto;
  }
  .modal-close-button:hover {
    color: #ff4444;
    transform: none; /* Override button hover transform */
    box-shadow: none;
  }

  /* Responsive DÃ¼zenlemeler */
  @media (max-width: 768px) {
    .box-container {
      grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
      max-width: 95%;
    }
    header {
      font-size: 22px;
    }
    #tablesWrapper {
      flex-direction: column;
      align-items: center;
    }
    .tableBox {
      width: 90%;
      max-width: 400px;
    }
    #adminPanel, #loginDiv {
      max-width: 90%;
      padding: 15px;
    }
    input, button {
      width: calc(100% - 20px);
      box-sizing: border-box;
      margin-left: 0;
      margin-right: 0;
    }
  }
</style>
</head>
<body>
<header>WEIZENDTV ÅANS OYUNU</header>

<div id="loginDiv">
  <h2>KÄ°CK KULLANICI ADI ZORUNLU!!</h2>
  <input type="text" id="username" placeholder="Kick KullanÄ±cÄ± AdÄ±" autocomplete="username" /><br/>
  <input type="password" id="password" placeholder="Åifre (KayÄ±t Ol)" autocomplete="new-password" /><br/>
  <button onclick="login()">GiriÅŸ Yap / KayÄ±t Ol</button>
  <p><a href="https://instagram.com/weizendtv" target="_blank" style="color:#ff4444;">Åifremi Unuttum</a></p>
</div>

<div id="gameDiv" style="display:none;">
  <h3>HoÅŸgeldin, <span id="currentUser"></span> <span id="role"></span></h3>
  <p id="balance">Bakiye: 0</p>
  <button onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>

  <p>Toplam AÃ§Ä±lan Kutu SayÄ±sÄ±: <span id="totalOpenedBoxesCount">0</span></p>

  <div class="box-container" id="boxContainer"></div>

  <div id="tablesWrapper">
    <div class="tableBox">
      <h3>KULLANICI SIRALAMASI</h3>
      <p>Toplam KullanÄ±cÄ±: <span id="totalUsersCount">0</span></p>
      <div id="allUserRankings" class="scrollable-list">YÃ¼kleniyor...</div>
    </div>
    <div class="tableBox">
      <h3>KAZANANLAR SIRALAMASI</h3>
      <div id="winners">YÃ¼kleniyor...</div>
    </div>
  </div>

  <div id="adminPanel" style="display:none;">
    <h3>Admin Paneli</h3>

    <h4>Onay Bekleyen KullanÄ±cÄ±lar</h4>
    <div id="pendingUsers" class="scrollable-list">YÃ¼kleniyor...</div>

    <h4>TÃ¼m KullanÄ±cÄ± Ä°ÅŸlemleri</h4>
    <input type="number" id="globalPoint" placeholder="Puan MiktarÄ±" min="1" /><br>
    <button onclick="changeAllPoints(true)">Toplu Puan Ekle</button>
    <button onclick="changeAllPoints(false)">Toplu Puan Sil</button>
    <br>
    <button onclick="revealAll()">TÃ¼m KutularÄ± AÃ§</button>
    <button onclick="resetGame()">Oyunu BaÅŸtan BaÅŸlat</button>
    <br>
    <button onclick="resetDailyBoxOpenRanking()">GÃ¼nlÃ¼k SÄ±ralamayÄ± SÄ±fÄ±rla</button>
    <button onclick="resetAllTimeBoxOpenRanking()">TÃ¼m ZamanlarÄ± SÄ±fÄ±rla</button>
    <br>
    <button onclick="resetWinnersRanking()">Hediye Kazananlar SÄ±ralamasÄ±nÄ± SÄ±fÄ±rla</button>


    <h4>KullanÄ±cÄ± YÃ¶netimi</h4>
    <input type="text" id="searchUser" placeholder="KullanÄ±cÄ± Ara" oninput="searchUsers()" /><br>
    <div id="allUsers" class="scrollable-list">YÃ¼kleniyor...</div>
  </div>
</div>

<div id="pointAdjustmentModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <button class="modal-close-button" onclick="closePointAdjustmentModal()">&times;</button>
    <h4>KullanÄ±cÄ± Puan AyarÄ±: <span id="adjUserName"></span></h4>
    <p>Mevcut Bakiye: <span id="adjUserBalance"></span> puan</p>
    <input type="number" id="adjAmount" placeholder="Puan MiktarÄ±" min="1" /><br>
    <button onclick="adjustUserPoints(true)">Puan Ekle</button>
    <button onclick="adjustUserPoints(false)">Puan Ã‡Ä±kar</button>
  </div>
</div>

<div id="blockDurationModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <button class="modal-close-button" onclick="closeBlockDurationModal()">&times;</button>
    <h4>KullanÄ±cÄ±yÄ± Engelle: <span id="blockUserName"></span></h4>
    <p>Engelleme SÃ¼resi (Dakika):</p>
    <input type="number" id="blockDuration" placeholder="SÃ¼re (dakika)" min="1" /><br>
    <button onclick="confirmBlockUser()">Engellemeyi Onayla</button>
  </div>
</div>

<div id="blockedMessageModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h4>HesabÄ±nÄ±z Engellendi!</h4>
    <p id="blockedReason"></p>
    <p id="blockedCountdown"></p>
    <button onclick="closeBlockedMessageModal()">Tamam</button>
  </div>
</div>


<script>
  // Firebase SDK v9 (Modular API) fonksiyonlarÄ±nÄ± kullanmak iÃ§in window objesine atadÄ±k.
  // Bu, HTML'deki inline ve <script> tag'indeki fonksiyonlarÄ±n eriÅŸebilmesini saÄŸlar.
  const db = window.db;
  const auth = window.auth;
  const ref = window.ref;
  const onValue = window.onValue;
  const set = window.set;
  const update = window.update;
  const remove = window.remove;
  const push = window.push;
  const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
  const onAuthStateChanged = window.onAuthStateChanged;
  const signOut = window.signOut;

  let currentUser = null;
  let isAdmin = false;
  let boxes = [];
  const COST_PER_BOX = 500;

  const pointAdjustmentModal = document.getElementById('pointAdjustmentModal');
  const blockDurationModal = document.getElementById('blockDurationModal');
  const blockedMessageModal = document.getElementById('blockedMessageModal');

  let targetUserForAdjustment = null;
  let targetUserForBlock = null;
  let countdownInterval = null;

  // Sayfa yÃ¼klendiÄŸinde ve oturum durumu deÄŸiÅŸtiÄŸinde Ã§alÄ±ÅŸacak kÄ±sÄ±m
  onAuthStateChanged(auth, user => {
    if (user) {
      // Firebase Auth ile giriÅŸ yapmÄ±ÅŸ bir kullanÄ±cÄ± var
      const firebaseAuthUsername = user.email.split('@')[0].toLowerCase(); // E-postanÄ±n baÅŸÄ±nÄ± kullanÄ±cÄ± adÄ± olarak alÄ±yoruz
      console.log("Firebase Auth Ã¼zerinden oturum algÄ±landÄ±:", firebaseAuthUsername);

      // Admin Ã¶zel kullanÄ±cÄ± adÄ± kontrolÃ¼ (Firebase Auth email'i ile)
      if (firebaseAuthUsername === "weizendtv") {
        currentUser = "WeizendTv"; // GÃ¶rÃ¼ntÃ¼lenen isim
        isAdmin = true;
        afterLogin();
      } else {
        // Normal bir Firebase Auth kullanÄ±cÄ±sÄ± (eÄŸer ilerde kullanmak istersek)
        // Åimdilik sadece Realtime DB kullanÄ±cÄ±larÄ±nÄ± ele alÄ±yoruz.
        // signOut(auth) yaparak bu oturumu kapatabiliriz eÄŸer Realtime DB'deki kullanÄ±cÄ±lar harici bir giriÅŸse.
        // Veya Kick kullanÄ±cÄ± adlarÄ±nÄ± Firebase Auth ile eÅŸleÅŸtirmemiz gerekir.
        // Åimdilik, admin dÄ±ÅŸÄ±ndaki Auth kullanÄ±cÄ±larÄ±nÄ± direkt normal loginDiv'e yÃ¶nlendiriyoruz.
        signOut(auth).then(() => {
          displayMessage("LÃ¼tfen Kick KullanÄ±cÄ± AdÄ±nÄ±z ile giriÅŸ yapÄ±n.");
          document.getElementById("loginDiv").style.display = "block";
          document.getElementById("gameDiv").style.display = "none";
        });
      }
    } else {
      // Oturum yok veya Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±
      console.log("Firebase Auth oturumu bulunamadÄ±.");
      document.getElementById("loginDiv").style.display = "block";
      document.getElementById("gameDiv").style.display = "none";
    }
  });


  async function login() {
    const user = document.getElementById("username").value.trim().toLowerCase();
    const pass = document.getElementById("password").value.trim();

    console.log("GiriÅŸ denemesi:", { user, pass });

    if (!user || !pass) {
      displayMessage("KullanÄ±cÄ± adÄ± ve ÅŸifre boÅŸ bÄ±rakÄ±lamaz!");
      return;
    }
    if (user.length < 3) {
      displayMessage("KullanÄ±cÄ± adÄ± en az 3 karakter olmalÄ±!");
      return;
    }
    if (pass.length < 6) {
      displayMessage("Åifre en az 6 karakter olmalÄ±!");
      return;
    }

    // Admin giriÅŸi (Firebase Authentication Ã¼zerinden)
    if (user === "weizendtv") {
      const adminEmail = "weizendtv@weizendtvoyun.com"; // Firebase Auth'a eklediÄŸin e-posta
      try {
        await signInWithEmailAndPassword(auth, adminEmail, pass);
        // onAuthStateChanged tetiklenecek ve afterLogin Ã§aÄŸrÄ±lacak
        displayMessage("Admin olarak giriÅŸ baÅŸarÄ±lÄ±!");
      } catch (error) {
        console.error("Admin Firebase Auth giriÅŸ hatasÄ±: ", error);
        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          displayMessage("Admin kullanÄ±cÄ± adÄ± veya ÅŸifresi yanlÄ±ÅŸ!");
        } else {
          displayMessage("Admin giriÅŸi sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message);
        }
      }
      return;
    }

    // Normal kullanÄ±cÄ± giriÅŸi (Realtime Database Ã¼zerinden)
    onValue(ref(db, 'users/' + user), (snap) => {
      if (snap.exists()) {
        let data = snap.val();
        console.log("KullanÄ±cÄ± verisi bulundu:", data);

        if (data.password !== pass) {
          displayMessage("Åifre yanlÄ±ÅŸ!");
        } else if (!data.approved) {
          displayMessage("HesabÄ±nÄ±z admin onayÄ± bekliyor. LÃ¼tfen bekleyin.");
        } else if (data.blocked) {
          checkUserBlockStatusAndLogin(user, data);
        } else {
          currentUser = user;
          isAdmin = false; // Normal kullanÄ±cÄ±
          console.log("KullanÄ±cÄ± olarak giriÅŸ yapÄ±ldÄ±:", currentUser);
          afterLogin();
        }
      } else {
        // Yeni kullanÄ±cÄ± kaydÄ±
        console.log("Yeni kullanÄ±cÄ± kaydÄ± yapÄ±lÄ±yor:", user);
        set(ref(db, 'users/' + user), {
          password: pass,
          balance: 0,
          approved: false,
          blocked: false,
          blockedUntil: null,
          boxesOpenedCount: 0,
          currentSessionBoxesOpened: 0,
          registeredAt: new Date().toLocaleString()
        }).then(() => {
          displayMessage("HesabÄ±nÄ±z baÅŸarÄ±yla oluÅŸturuldu! Admin onayÄ± bekleniyor.");
        }).catch(error => {
          console.error("Firebase kayÄ±t hatasÄ±: ", error);
          displayMessage("KayÄ±t olurken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.");
        });
      }
    }, {
      onlyOnce: true // Sadece bir kere oku
    }).catch(error => {
      console.error("Firebase veritabanÄ± okuma hatasÄ±: ", error);
      displayMessage("GiriÅŸ yaparken bir sorun oluÅŸtu (veritabanÄ± baÄŸlantÄ±sÄ±). LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
    });
  }

  function checkUserBlockStatusAndLogin(userToCheck, userData = null) {
    const user = userData;
    if (user && user.blocked) {
      const blockedUntil = user.blockedUntil;
      if (blockedUntil && Date.now() < blockedUntil) {
        displayBlockedMessage(blockedUntil);
      } else if (blockedUntil && Date.now() >= blockedUntil) {
        update(ref(db, 'users/' + userToCheck), { blocked: false, blockedUntil: null })
          .then(() => {
            displayMessage("Engelleme sÃ¼reniz doldu. GiriÅŸ yapÄ±lÄ±yor...");
            currentUser = userToCheck;
            isAdmin = false;
            afterLogin();
          })
          .catch(error => console.error("Engeli kaldÄ±rma hatasÄ±:", error));
      } else {
        displayMessage("HesabÄ±nÄ±z sÃ¼resiz engellendi. LÃ¼tfen admin ile iletiÅŸime geÃ§in.");
        document.getElementById("loginDiv").style.display = "block";
        document.getElementById("gameDiv").style.display = "none";
      }
    } else {
      currentUser = userToCheck;
      isAdmin = false;
      afterLogin();
    }
  }

  function afterLogin() {
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("gameDiv").style.display = "block";
    document.getElementById("currentUser").textContent = currentUser;
    document.getElementById("role").textContent = isAdmin ? "(Admin)" : "";

    if (isAdmin) {
      document.getElementById("adminPanel").style.display = "block";
      loadPendingUsers();
      loadAllUsers();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }

    loadBalance();
    loadUserRankingsAndBoxCounts();
    loadWinners();
    loadBoxes();
    loadTotalOpenedBoxesCount();
  }

  async function logout() {
    try {
      await signOut(auth); // Firebase Auth oturumunu kapat
      currentUser = null;
      isAdmin = false;
      location.reload(); // SayfayÄ± yenileyerek giriÅŸ ekranÄ±na dÃ¶n
    } catch (error) {
      console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu: ", error);
      displayMessage("Ã‡Ä±kÄ±ÅŸ yaparken bir hata oluÅŸtu.");
    }
  }

  function loadBalance() {
    if (isAdmin) {
      document.getElementById("balance").textContent = "Bakiye: âˆ (Admin)";
      return;
    }
    onValue(ref(db, 'users/' + currentUser + '/balance'), snap => {
      document.getElementById("balance").textContent = "Bakiye: " + (snap.val() || 0) + " puan";
    });
  }

  function loadUserRankingsAndBoxCounts() {
    onValue(ref(db, 'users'), userSnap => {
      let usersData = userSnap.val();

      if (!usersData) {
        document.getElementById("allUserRankings").innerHTML = "HenÃ¼z veri yok.";
        document.getElementById("totalUsersCount").textContent = "0";
        return;
      }

      let allUsersArray = Object.entries(usersData);
      let rankedUsers = [];
      let totalUsers = 0;

      allUsersArray.forEach(([username, userData]) => {
        if (username === "weizendtv" && isAdmin) return;

        totalUsers++;
        const boxesOpenedCount = userData.boxesOpenedCount || 0;
        const currentSessionBoxesOpened = userData.currentSessionBoxesOpened || 0;

        if (userData.approved && !userData.blocked) {
          rankedUsers.push({
            username: username,
            balance: userData.balance || 0,
            boxesOpenedCount: boxesOpenedCount,
            currentSessionBoxesOpened: currentSessionBoxesOpened
          });
        }
      });

      rankedUsers.sort((a, b) => b.boxesOpenedCount - a.boxesOpenedCount);

      let html = rankedUsers.map((u, i) =>
        `<b>${i + 1}.</b> ${u.username}<br>` +
        `&nbsp;&nbsp;AÃ§Ä±lan Kutu: (Åu An) ${u.currentSessionBoxesOpened} - (Toplam) ${u.boxesOpenedCount}<br>` +
        `&nbsp;&nbsp;Puan: ${u.balance}`
      ).join("<br><br>");

      document.getElementById("allUserRankings").innerHTML = html || "HenÃ¼z sÄ±ralanacak kullanÄ±cÄ± yok.";
      document.getElementById("totalUsersCount").textContent = totalUsers;
    });
  }

  function loadWinners() {
    onValue(ref(db, 'winners'), snap => {
      let data = snap.val();
      if (!data) { document.getElementById("winners").innerHTML = "HenÃ¼z kazanan yok."; return; }
      let winnerCount = {};
      Object.values(data).forEach(w => { winnerCount[w.name] = (winnerCount[w.name] || 0) + 1; });
      let sorted = Object.entries(winnerCount).sort((a,b) => b[1]-a[1]).slice(0,10);
      let html = sorted.map((w,i) => `<b>${i+1}.</b> ğŸ ${w[0]} - ${w[1]}x`).join("<br>");
      document.getElementById("winners").innerHTML = html;
    });
  }

  function loadPendingUsers() {
    onValue(ref(db, 'users'), snap => {
      const data = snap.val();
      let html = "";
      for (const u in data) {
        if (!data[u].approved) {
          html += `<div class="userItem">
            <span>${u} (KayÄ±t: ${data[u].registeredAt || 'Bilinmiyor'})</span>
            <div>
            <button onclick="approveUser('${u}')">Onayla</button>
            <button onclick="denyUser('${u}', true)" style="background: #e57373;">Sil</button></div></div>`;
        }
      }
      document.getElementById("pendingUsers").innerHTML = html || "Onay bekleyen kullanÄ±cÄ± yok.";
    });
  }

  function loadAllUsers() {
    onValue(ref(db, 'users'), snap => {
      const data = snap.val();
      let html = "";
      for (const u in data) {
        if (u === "weizendtv" && isAdmin) continue;

        html += `<div class="userItem" onclick="openPointAdjustmentModal('${u}')">
            <span>${u} - ${data[u].balance} puan ${data[u].blocked ? '(Engelli)' : ''}</span>
            <div>
            <button onclick="event.stopPropagation(); toggleBlockUser('${u}', ${data[u].blocked || false})">
              ${data[u].blocked ? 'Engeli KaldÄ±r' : 'Engelle'}
            </button>
            <button onclick="event.stopPropagation(); denyUser('${u}')" style="background: #e57373;">Sil</button>
            </div>
            </div>`;
      }
      document.getElementById("allUsers").innerHTML = html || "KullanÄ±cÄ± yok.";
    });
  }

  function displayMessage(message) {
    const messageBox = document.createElement('div');
    messageBox.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #333;
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      z-index: 1000;
      text-align: center;
      font-size: 18px;
      border: 2px solid #b71c1c;
    `;
    messageBox.textContent = message;
    document.body.appendChild(messageBox);

    setTimeout(() => {
      messageBox.remove();
    }, 3000);
  }

  function customConfirm(message, callback) {
    const confirmBox = document.createElement('div');
    confirmBox.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #222;
      color: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      z-index: 1000;
      text-align: center;
      font-size: 18px;
      border: 2px solid #b71c1c;
      max-width: 400px;
      width: 90%;
    `;
    confirmBox.innerHTML = `
      <p>${message}</p>
      <button id="confirmYes" style="margin-right: 15px; background: #4CAF50;">Evet</button>
      <button id="confirmNo" style="background: #f44336;">HayÄ±r</button>
    `;
    document.body.appendChild(confirmBox);

    document.getElementById('confirmYes').onclick = () => {
      confirmBox.remove();
      callback(true);
    };
    document.getElementById('confirmNo').onclick = () => {
      confirmBox.remove();
      callback(false);
    };
  }

  function openPointAdjustmentModal(username) {
    targetUserForAdjustment = username;
    document.getElementById('adjUserName').textContent = username;
    onValue(ref(db, 'users/' + username + '/balance'), snap => {
      document.getElementById('adjUserBalance').textContent = snap.val() || 0;
    }, {
      onlyOnce: true
    }).catch(error => console.error("Bakiye okuma hatasÄ±:", error));
    pointAdjustmentModal.style.display = 'flex';
  }

  function closePointAdjustmentModal() {
    pointAdjustmentModal.style.display = 'none';
    document.getElementById('adjAmount').value = '';
    targetUserForAdjustment = null;
  }

  function adjustUserPoints(add) {
    const amount = parseInt(document.getElementById('adjAmount').value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("GeÃ§erli bir pozitif puan miktarÄ± girin!");
      return;
    }

    onValue(ref(db, 'users/' + targetUserForAdjustment), (snap) => {
      let userBalance = snap.val().balance || 0;
      userBalance = add ? userBalance + amount : Math.max(userBalance - amount, 0);
      set(ref(db, 'users/' + targetUserForAdjustment + '/balance'), userBalance)
        .then(() => {
          displayMessage(`${targetUserForAdjustment} kullanÄ±cÄ±sÄ±nÄ±n yeni bakiyesi: ${userBalance} puan`);
          closePointAdjustmentModal();
          loadAllUsers();
          loadUserRankingsAndBoxCounts();
        })
        .catch(error => console.error("Bakiye gÃ¼ncelleme hatasÄ±: ", error));
    }, {
      onlyOnce: true
    }).catch(error => console.error("KullanÄ±cÄ± verisi okuma hatasÄ±: ", error));
  }

  function openBlockDurationModal(username) {
    targetUserForBlock = username;
    document.getElementById('blockUserName').textContent = username;
    blockDurationModal.style.display = 'flex';
  }

  function closeBlockDurationModal() {
    blockDurationModal.style.display = 'none';
    document.getElementById('blockDuration').value = '';
    targetUserForBlock = null;
  }

  function confirmBlockUser() {
    const duration = parseInt(document.getElementById('blockDuration').value);
    if (isNaN(duration) || duration <= 0) {
      displayMessage("GeÃ§erli bir pozitif sÃ¼re (dakika) girin!");
      return;
    }

    const blockedUntil = Date.now() + duration * 60 * 1000;
    update(ref(db, 'users/' + targetUserForBlock), {
      blocked: true,
      blockedUntil: blockedUntil
    }).then(() => {
      displayMessage(`${targetUserForBlock} kullanÄ±cÄ±sÄ± ${duration} dakika engellendi.`);
      closeBlockDurationModal();
      loadAllUsers();
      loadUserRankingsAndBoxCounts();
    }).catch(error => console.error("KullanÄ±cÄ± engelleme hatasÄ±:", error));
  }

  function toggleBlockUser(user, currentStatus) {
    if (currentStatus) {
      customConfirm(user + " kullanÄ±cÄ±sÄ±nÄ±n engelini kaldÄ±rmak istediÄŸinize emin misiniz?", (result) => {
        if (result) {
          update(ref(db, 'users/' + user), { blocked: false, blockedUntil: null })
            .then(() => {
              displayMessage(user + " kullanÄ±cÄ±sÄ±nÄ±n engeli kaldÄ±rÄ±ldÄ±.");
              loadAllUsers();
              loadUserRankingsAndBoxCounts();
            })
            .catch(error => console.error("Engeli kaldÄ±rma hatasÄ±: ", error));
        }
      });
    } else {
      openBlockDurationModal(user);
    }
  }

  function approveUser(user) {
    customConfirm(user + " kullanÄ±cÄ±sÄ±nÄ± onaylamak istediÄŸinize emin misiniz?", (result) => {
      if (result) {
        update(ref(db, 'users/' + user), { approved: true, blocked: false, blockedUntil: null })
          .then(() => {
            displayMessage(user + " kullanÄ±cÄ±sÄ± onaylandÄ±.");
            loadPendingUsers();
            loadAllUsers();
            loadUserRankingsAndBoxCounts();
          }).catch(error => console.error("KullanÄ±cÄ± onaylama hatasÄ±: ", error));
      }
    });
  }

  function denyUser(user, fromPending = false) {
    customConfirm(user + " kullanÄ±cÄ±sÄ±nÄ± tamamen silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz ve kullanÄ±cÄ± adÄ± tekrar kullanÄ±labilir hale gelir!", (result) => {
      if (result) {
        remove(ref(db, 'users/' + user))
          .then(() => {
            displayMessage(user + " kullanÄ±cÄ±sÄ± silindi ve adÄ± tekrar kullanÄ±labilir.");
            if (fromPending) {
              loadPendingUsers();
            }
            loadAllUsers();
            loadUserRankingsAndBoxCounts();
          }).catch(error => console.error("KullanÄ±cÄ± silme hatasÄ±: ", error));
      }
    });
  }

  function changeAllPoints(add) {
    const amount = parseInt(document.getElementById("globalPoint").value);
    if (isNaN(amount) || amount <= 0) {
      displayMessage("GeÃ§erli bir pozitif puan miktarÄ± girin!");
      return;
    }

    customConfirm(`TÃ¼m onaylÄ± ve engellenmemiÅŸ kullanÄ±cÄ±lara ${add ? 'eklemek' : 'silmek'} istediÄŸinizden emin misiniz?`, (result) => {
      if (result) {
        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {}; // Renamed from 'updates' to 'updatesObj' to avoid conflict with imported 'update' function
          snap.forEach(child => {
            if (child.val().approved && !child.val().blocked && child.key !== "weizendtv") {
              let balance = child.val().balance || 0;
              balance = add ? balance + amount : Math.max(balance - amount, 0);
              updatesObj['users/' + child.key + '/balance'] = balance;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("TÃ¼m onaylÄ± kullanÄ±cÄ±larÄ±n bakiyeleri gÃ¼ncellendi."))
            .catch(error => console.error("Toplu bakiye gÃ¼ncelleme hatasÄ±: ", error));
        }, {
          onlyOnce: true
        });
      }
    });
  }

  function createBoxes() {
    boxes = [];
    const totalBoxes = 100;
    const winnerCount = 1;
    const pointsPerWinner = 1000;

    for (let i = 1; i <= totalBoxes; i++) {
      boxes.push({ id: i, content: 'bomba', opened: false, opener: '' });
    }

    let selectedWinners = new Set();
    while (selectedWinners.size < winnerCount) {
      let winnerIndex = Math.floor(Math.random() * totalBoxes);
      if (!selectedWinners.has(winnerIndex)) {
        selectedWinners.add(winnerIndex);
        boxes[winnerIndex].content = 'surpriz';
        boxes[winnerIndex].points = pointsPerWinner;
      }
    }
    set(ref(db, 'boxes'), boxes)
      .then(() => console.log("Kutular oluÅŸturuldu/sÄ±fÄ±rlandÄ±."))
      .catch(error => console.error("Kutu oluÅŸturma hatasÄ±: ", error));
  }

  function loadBoxes() {
    onValue(ref(db, 'boxes'), snap => {
      if (!snap.exists()) {
        createBoxes();
      } else {
        boxes = snap.val();
        renderBoxes();
        loadTotalOpenedBoxesCount();
      }
    });
  }

  function renderBoxes() {
    const container = document.getElementById("boxContainer");
    container.innerHTML = '';
    boxes.forEach((box, i) => {
      let div = document.createElement('div');
      div.className = 'box ' + (box.opened ? 'opened' : '');
      if (box.opened) {
        div.textContent = box.content === 'bomba' ? 'ğŸ’£' : 'ğŸ Tebrikler!';
        if (box.opener) {
          let openerDiv = document.createElement('div');
          openerDiv.className = 'opener';
          openerDiv.textContent = box.opener;
          div.appendChild(openerDiv);
        }
      } else {
        div.textContent = box.id;
      }
      div.onclick = () => openBox(i);
      if (box.content === 'bomba' && box.opened) div.classList.add('bomba');
      if (box.content === 'surpriz' && box.opened) div.classList.add('winner');
      container.appendChild(div);
    });
  }

  function openBox(index) {
    if (boxes[index].opened) return;

    if (isAdmin) { // Adminler puan harcamadan kutu aÃ§abilir
      boxes[index].opened = true;
      boxes[index].opener = 'Admin';
      set(ref(db, 'boxes'), boxes)
        .then(() => renderBoxes())
        .catch(error => console.error("Admin kutu aÃ§ma hatasÄ±: ", error));
      return;
    }

    onValue(ref(db, 'users/' + currentUser), (snap) => {
      let user = snap.val();
      if (!user) {
        displayMessage("KullanÄ±cÄ± bilginiz bulunamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
        logout();
        return;
      }
      if (user.blocked) {
        displayMessage("HesabÄ±nÄ±z engelli olduÄŸu iÃ§in kutu aÃ§amazsÄ±nÄ±z.");
        return;
      }
      if (user.balance < COST_PER_BOX) {
        displayMessage(`Kutu aÃ§mak iÃ§in ${COST_PER_BOX} puana ihtiyacÄ±n var. Mevcut bakiyen: ${user.balance}.`);
        return;
      }

      user.balance -= COST_PER_BOX;
      boxes[index].opened = true;
      boxes[index].opener = currentUser;

      user.boxesOpenedCount = (user.boxesOpenedCount || 0) + 1;
      user.currentSessionBoxesOpened = (user.currentSessionBoxesOpened || 0) + 1;

      const updatesObj = {};
      updatesObj['users/' + currentUser + '/balance'] = user.balance;
      updatesObj['users/' + currentUser + '/boxesOpenedCount'] = user.boxesOpenedCount;
      updatesObj['users/' + currentUser + '/currentSessionBoxesOpened'] = user.currentSessionBoxesOpened;
      updatesObj['boxes'] = boxes;

      if (boxes[index].content === 'surpriz') {
        const pointsWon = boxes[index].points || 1000;
        user.balance += pointsWon;
        updatesObj['users/' + currentUser + '/balance'] = user.balance;
        push(ref(db, 'winners'), { name: currentUser, date: new Date().toLocaleString(), points: pointsWon });
        displayMessage(`Tebrikler! ${pointsWon} puan kazandÄ±nÄ±z! Yeni bakiyeniz: ${user.balance}`);
      } else {
        displayMessage(`Kutu aÃ§Ä±ldÄ±. ${COST_PER_BOX} puan harcadÄ±nÄ±z. Yeni bakiyeniz: ${user.balance}`);
      }

      update(ref(db), updatesObj)
        .then(() => renderBoxes())
        .catch(error => console.error("Kutu aÃ§ma iÅŸlemi hatasÄ±: ", error));
    }, {
      onlyOnce: true
    }).catch(error => {
      console.error("KullanÄ±cÄ± verisi okuma hatasÄ±: ", error);
      displayMessage("Kutu aÃ§Ä±lÄ±rken bir hata oluÅŸtu. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± veya konsolu kontrol edin.");
    });
  }

  function revealAll() {
    customConfirm("TÃ¼m kutularÄ± aÃ§mak istediÄŸinize emin misiniz?", (result) => {
      if (result) {
        boxes.forEach(b => {
          if (!b.opened) {
            b.opened = true;
            b.opener = 'Admin (Hepsi AÃ§Ä±ldÄ±)';
          }
        });
        set(ref(db, 'boxes'), boxes)
          .then(() => renderBoxes())
          .catch(error => console.error("TÃ¼m kutularÄ± aÃ§ma hatasÄ±: ", error));
      }
    });
  }

  function resetGame() {
    customConfirm("Oyunu sÄ±fÄ±rlamak istediÄŸinize emin misiniz? TÃ¼m kutular kapanacak ve yeni bir kazanan kutusu belirlenecek. KullanÄ±cÄ± bakiyeleri etkilenmez.", (result) => {
      if (result) {
        createBoxes();

        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {};
          snap.forEach(child => {
            if (child.key !== "weizendtv") { // Admini sÄ±fÄ±rlama dÄ±ÅŸÄ±nda bÄ±rak
              updatesObj['users/' + child.key + '/currentSessionBoxesOpened'] = 0;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("Oyun baÅŸarÄ±yla sÄ±fÄ±rlandÄ±. TÃ¼m kullanÄ±cÄ±larÄ±n gÃ¼nlÃ¼k kutu aÃ§ma sayÄ±larÄ± sÄ±fÄ±rlandÄ±."))
            .catch(error => console.error("GÃ¼nlÃ¼k kutu aÃ§ma sÄ±fÄ±rlama hatasÄ±: ", error));
        }, {
          onlyOnce: true
        }).catch(error => console.error("KullanÄ±cÄ±larÄ± sÄ±fÄ±rlama hatasÄ±:", error));
      }
    });
  }

  function resetDailyBoxOpenRanking() {
    customConfirm("TÃ¼m kullanÄ±cÄ±larÄ±n 'Åu An AÃ§Ä±lan Kutu' sayÄ±larÄ±nÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.", (result) => {
      if (result) {
        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {};
          snap.forEach(child => {
            if (child.key !== "weizendtv") { // Admini sÄ±fÄ±rlama dÄ±ÅŸÄ±nda bÄ±rak
              updatesObj['users/' + child.key + '/currentSessionBoxesOpened'] = 0;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n gÃ¼nlÃ¼k kutu aÃ§ma sayÄ±larÄ± sÄ±fÄ±rlandÄ±."))
            .catch(error => console.error("GÃ¼nlÃ¼k kutu aÃ§ma sÄ±fÄ±rlama hatasÄ±: ", error));
        }, {
          onlyOnce: true
        });
      }
    });
  }

  function resetAllTimeBoxOpenRanking() {
    customConfirm("TÃ¼m kullanÄ±cÄ±larÄ±n 'Toplam AÃ§Ä±lan Kutu' sayÄ±larÄ±nÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.", (result) => {
      if (result) {
        onValue(ref(db, 'users'), (snap) => {
          const updatesObj = {};
          snap.forEach(child => {
            if (child.key !== "weizendtv") { // Admini sÄ±fÄ±rlama dÄ±ÅŸÄ±nda bÄ±rak
              updatesObj['users/' + child.key + '/boxesOpenedCount'] = 0;
            }
          });
          update(ref(db), updatesObj)
            .then(() => displayMessage("TÃ¼m kullanÄ±cÄ±larÄ±n tÃ¼m zamanlar kutu aÃ§ma sayÄ±larÄ± sÄ±fÄ±rlandÄ±."))
            .catch(error => console.error("TÃ¼m zamanlar kutu aÃ§ma sÄ±fÄ±rlama hatasÄ±: ", error));
        }, {
          onlyOnce: true
        });
      }
    });
  }

  function resetWinnersRanking() {
    customConfirm("Hediye kazananlar sÄ±ralamasÄ±nÄ± sÄ±fÄ±rlamak istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.", (result) => {
      if (result) {
        remove(ref(db, 'winners'))
          .then(() => displayMessage("Hediye kazananlar sÄ±ralamasÄ± sÄ±fÄ±rlandÄ±."))
          .catch(error => console.error("Kazananlar sÄ±ralamasÄ± sÄ±fÄ±rlama hatasÄ±: ", error));
      }
    });
  }

  function loadTotalOpenedBoxesCount() {
    onValue(ref(db, 'boxes'), snap => {
      const allBoxes = snap.val();
      let openedCount = 0;
      if (allBoxes) {
        openedCount = allBoxes.filter(box => box.opened).length;
      }
      document.getElementById('totalOpenedBoxesCount').textContent = openedCount;
    });
  }

  function searchUsers() {
    const term = document.getElementById("searchUser").value.trim().toLowerCase();
    onValue(ref(db, 'users'), (snap) => {
      const data = snap.val();
      let html = "";
      for (const u in data) {
        if (u === "weizendtv" && isAdmin) continue;

        if (u.toLowerCase().includes(term)) {
          html += `<div class="userItem" onclick="openPointAdjustmentModal('${u}')">
            <span>${u} - ${data[u].balance} puan ${data[u].blocked ? '(Engelli)' : ''}</span>
            <div>
            <button onclick="event.stopPropagation(); toggleBlockUser('${u}', ${data[u].blocked || false})">
              ${data[u].blocked ? 'Engeli KaldÄ±r' : 'Engelle'}
            </button>
            <button onclick="event.stopPropagation(); denyUser('${u}')" style="background: #e57373;">Sil</button>
            </div>
            </div>`;
        }
      }
      document.getElementById("allUsers").innerHTML = html || "KullanÄ±cÄ± bulunamadÄ±.";
    }, {
      onlyOnce: true
    });
  }

  function displayBlockedMessage(blockedUntil) {
    blockedMessageModal.style.display = 'flex';
    document.getElementById('blockedReason').textContent = "HesabÄ±nÄ±z geÃ§ici olarak engellendi.";

    clearInterval(countdownInterval);

    const updateCountdown = () => {
      const timeLeft = blockedUntil - Date.now();
      if (timeLeft <= 0) {
        document.getElementById('blockedCountdown').textContent = "Engel sÃ¼reniz doldu. LÃ¼tfen tekrar giriÅŸ yapÄ±n.";
        clearInterval(countdownInterval);
        update(ref(db, 'users/' + currentUser), { blocked: false, blockedUntil: null })
          .then(() => {
            displayMessage("Engeliniz kaldÄ±rÄ±ldÄ±, lÃ¼tfen tekrar giriÅŸ yapÄ±n.");
            closeBlockedMessageModal();
            // Burada kullanÄ±cÄ±yÄ± otomatik olarak tekrar denetleyebiliriz veya logout ile sÄ±fÄ±rlayabiliriz.
            // Åimdilik logout Ã§aÄŸÄ±rarak giriÅŸ ekranÄ±na dÃ¶nmesini saÄŸlayalÄ±m.
            logout();
          })
          .catch(error => console.error("Engeli kaldÄ±rma hatasÄ±:", error));

        return;
      }

      const minutes = Math.floor(timeLeft / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      document.getElementById('blockedCountdown').textContent = `Kalan sÃ¼re: ${minutes} dakika ${seconds} saniye`;
    };

    countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
  }

  function closeBlockedMessageModal() {
    blockedMessageModal.style.display = 'none';
    clearInterval(countdownInterval);
    logout();
  }
</script>
</body>
</html>
